#!/usr/bin/env php
<?php

echo "\n\033[1;34mâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\033[0m\n";
echo "\033[1;34mâ•‘  Symfony Base Project Setup           â•‘\033[0m\n";
echo "\033[1;34mâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\033[0m\n\n";

// Prompt for project name
echo "\033[1;33mEnter your project name:\033[0m ";
$projectName = trim(fgets(STDIN));

if (empty($projectName)) {
    $projectName = 'My Symfony App';
    echo "\033[0;33mUsing default name: {$projectName}\033[0m\n";
}

// Prompt for vendor/package name
echo "\033[1;33mEnter your composer package name (vendor/package):\033[0m ";
$packageName = trim(fgets(STDIN));

if (empty($packageName) || !preg_match('/^[a-z0-9\-]+\/[a-z0-9\-]+$/', $packageName)) {
    $packageName = 'myvendor/myproject';
    echo "\033[0;33mUsing default package name: {$packageName}\033[0m\n";
}

// Update .env file
$envFile = __DIR__ . '/../.env';
if (!file_exists($envFile)) {
    echo "\033[0;31mError: .env file not found!\033[0m\n";
    exit(1);
}

$envContent = file_get_contents($envFile);
$envContent = preg_replace(
    '/^APP_NAME=.*$/m',
    'APP_NAME="' . addslashes($projectName) . '"',
    $envContent
);
file_put_contents($envFile, $envContent);

// Update composer.json
$composerFile = __DIR__ . '/../composer.json';
if (!file_exists($composerFile)) {
    echo "\033[0;31mError: composer.json file not found!\033[0m\n";
    exit(1);
}

$composerData = json_decode(file_get_contents($composerFile), true);
$composerData['name'] = $packageName;
$composerData['description'] = $projectName;
$composerData['version'] = '1.0.0';

// Remove the post-create-project-cmd script
if (isset($composerData['scripts']['post-create-project-cmd'])) {
    unset($composerData['scripts']['post-create-project-cmd']);
    if (empty($composerData['scripts'])) {
        unset($composerData['scripts']);
    }
}

file_put_contents($composerFile, json_encode($composerData, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES) . "\n");

echo "\n\033[1;32mâœ“ Project created successfully!\033[0m\n";
echo "\033[0;32mâœ“ APP_NAME set to: {$projectName}\033[0m\n";
echo "\033[0;32mâœ“ Composer package set to: {$packageName}\033[0m\n";
echo "\033[0;32mâœ“ Version set to: 1.0.0\033[0m\n\n";
echo "\033[1;36mNext steps:\033[0m\n";
echo "  1. Update other settings in .env file\n";
echo "  2. Run: \033[1mphp bin/console server:start\033[0m\n";
echo "  3. Visit: \033[1mhttp://localhost:8000\033[0m\n\n";
echo "\033[0;90mHappy coding! ðŸš€\033[0m\n\n";

// Clean up setup files
$setupScript = __FILE__;
$envTemplate = __DIR__ . '/../.env.template';
$readme = __DIR__ . '/../README.md';

if (file_exists($readme)) {
    unlink($readme);
}

if (file_exists($envTemplate)) {
    unlink($envTemplate);
}

if (file_exists($setupScript)) {
    unlink($setupScript);
}